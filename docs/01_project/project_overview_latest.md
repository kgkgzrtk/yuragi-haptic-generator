# Yuragi Haptic Generator - 最新プロジェクト概要

最終更新: 2025-08-04

## エグゼクティブサマリー

Yuragi Haptic Generatorプロジェクトは、非対称振動パターン（のこぎり波）を使用して革新的な力覚提示システムを実装します。デュアル2軸触覚アクチュエータを通じて、40-120Hzの範囲で精密な位相と周波数制御により方向性のある力覚を実現します。

## 現在の実装状況

### 完成した機能

#### バックエンド (FastAPI/Python)
- ✅ 4チャンネル独立制御システム
- ✅ 設定可能な時間比率でののこぎり波形生成
- ✅ パラメータ制御用REST API
- ✅ リアルタイムデータストリーミング用WebSocket
- ✅ 包括的なユニットテストカバレッジ (95%以上)
- ✅ チャンネル固有のパラメータ管理
- ✅ 波形反転用の極性制御
- ✅ テスト用ノイズシミュレーション
- ✅ ベクトル力覚計算（任意方向の力生成）

#### フロントエンド (React/TypeScript)
- ✅ リアルタイム波形可視化
- ✅ 個別チャンネル制御パネル
- ✅ ライブ更新用WebSocket統合
- ✅ 複数ビューポート対応のレスポンシブデザイン
- ✅ エラーハンドリングと回復メカニズム
- ✅ Zustandによる状態管理
- ✅ データ取得用React Query
- ✅ E2Eテスト（Playwright）

### アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                    ユーザーインターフェース (React)            │
├─────────────────────────────────────────────────────────────┤
│  制御パネル      │  波形チャート     │  ステータスインジケータ  │
├─────────────────────────────────────────────────────────────┤
│              WebSocket & REST API 通信                       │
├─────────────────────────────────────────────────────────────┤
│                   FastAPI バックエンドサーバー                 │
├─────────────────────────────────────────────────────────────┤
│  HapticController  │  WebSocketマネージャ  │  APIエンドポイント│
├─────────────────────────────────────────────────────────────┤
│                     コア触覚システム                          │
├─────────────────────────────────────────────────────────────┤
│  HapticDevice  │  HapticChannel × 4  │  SawtoothWaveform   │
├─────────────────────────────────────────────────────────────┤
│              オーディオ出力 (4チャンネル)                      │
└─────────────────────────────────────────────────────────────┘
```

## データフローと同期

### 波形更新メカニズム

1. **バックエンド生成**
   - 44.1kHzサンプルレートでの継続的な波形生成
   - 低レイテンシー用512サンプルブロック
   - 100ms毎のWebSocketブロードキャスト

2. **フロントエンドレンダリング**
   - HTTPポーリング: 50ms（リアルタイム）/ 100ms（標準）
   - パラメータ変更用WebSocket更新
   - パフォーマンス向上のためアニメーション無効化されたChart.js

3. **同期戦略**
   - ハイブリッドアプローチ: イベント用WebSocket、データ用HTTP
   - スムーズな可視化のためのクライアント側バッファリング
   - 接続切断時の自動再接続

### 更新頻度
- **バックエンドストリーミング**: 100ms間隔
- **フロントエンドポーリング**: モードに基づいて50-100ms
- **チャートリフレッシュ**: データ到着時（アニメーションなし）
- **目標レイテンシー**: <10msオーディオ出力

## 技術仕様

### オーディオ設定
- **サンプルレート**: 44,100 Hz
- **ブロックサイズ**: 512サンプル（~11.6ms）
- **チャンネル**: 4（2デバイス × 2軸）
- **ビット深度**: 16ビット（デバイス依存）

### 波形パラメータ
- **周波数範囲**: 40-120 Hz（最適: 60-120 Hz）
- **振幅**: 0.0 - 1.0（正規化）
- **位相**: 0° - 360°
- **時間比率**: 1:8（のこぎり波の上昇:下降）

### 通信プロトコル
- **REST API**: パラメータ更新、制御コマンド
- **WebSocket**: リアルタイムストリーミング、ステータス更新
- **メッセージタイプ**: 
  - `parameters_update`
  - `waveform_data`
  - `status_update`
  - `error`

## 開発プラクティス

### テスト戦略
- **TDDアプローチ**: テストファースト開発
- **ユニットテスト**: 95%以上のカバレッジ
- **統合テスト**: APIとシグナルパイプライン
- **E2Eテスト**: UIワークフロー用Playwright

### コード構成
```
yuragi-haptic-generator/
├── backend/
│   ├── src/
│   │   ├── haptic_system/   # コアロジック
│   │   ├── api/             # RESTエンドポイント
│   │   └── config/          # 設定
│   └── tests/
│       ├── unit/            # コンポーネントテスト
│       └── integration/     # システムテスト
└── frontend/
    ├── src/
    │   ├── components/      # UIコンポーネント
    │   ├── hooks/          # カスタムReactフック
    │   ├── services/       # APIクライアント
    │   └── contexts/       # 状態管理
    └── tests/
        └── e2e/            # エンドツーエンドテスト
```

## パフォーマンス特性

### 測定メトリクス
- **オーディオレイテンシー**: 8-12ms（目標: <10ms）
- **WebSocketレイテンシー**: 1-5ms（ローカル）
- **UI更新レート**: 20 FPS（50ms間隔）
- **CPU使用率**: <15%（4コアシステム）
- **メモリ使用量**: ~150MB（バックエンド）、~100MB（フロントエンド）

### 最適化戦略
- ゼロコピーオーディオストリーミング
- 効率的なnumpy操作
- Reactコンポーネントのメモ化
- WebSocket接続プーリング
- Chart.jsアニメーション無効化

## 今後の拡張

### 計画中の機能
1. **高度な波形**: 三角波、矩形波、カスタム形状
2. **16方向モード**: 事前定義された方向パターン
3. **キャリブレーションシステム**: デバイス固有の共振調整
4. **記録/再生**: セッションキャプチャとリプレイ
5. **マルチデバイスサポート**: 複数システムの同期

### 研究方向
- 最適な波形パラメータのための機械学習
- 触覚パターンライブラリ
- クロスモーダルフィードバック統合
- 分散触覚ネットワーク

## 統合ガイド

### ハードウェア要件
- Miraisense Hapticsデバイス（4チャンネル）
- 44.1kHz対応のUSB/オーディオインターフェース
- 低レイテンシーオーディオドライバ（ASIO/CoreAudio）

### ソフトウェア依存関係
- Python 3.9以上（NumPy、FastAPI）
- Node.js 16以上（React 18）
- WebSocketサポート付きモダンWebブラウザ

### クイックスタート
```bash
# バックエンド
cd backend
uv run uvicorn src.main:app --reload

# フロントエンド
cd frontend
pnpm install && pnpm dev
```

## 参考資料

- [システム要件](../02_requirements/system_requirements.md)
- [ソフトウェア設計](../03_design/software_design_mvp.md)
- [APIドキュメント](../07_implementation/api_documentation.md)
- [波形レンダリングとWebSocket同期](../07_implementation/waveform_rendering_websocket.md)
- [TDD開発レポート](../../backend/TDD_DEVELOPMENT_REPORT.md)